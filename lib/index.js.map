{"version":3,"file":"index.js","sources":["../src/utils.ts","../src/index.ts"],"sourcesContent":["\r\nexport const isObject = (item: any) => {\r\n  return (item && typeof item === 'object' && !Array.isArray(item))\r\n}\r\n\r\nexport const isArray = (item: any) => {\r\n  return (item && typeof item === 'object' && Array.isArray(item))\r\n}\r\n\r\nexport const mergeObjects: any = (target: any, ...sources: any) => {\r\n    if (!sources.length) return target;\r\n    const source = sources.shift();\r\n  \r\n    if (isObject(target) && isObject(source)) {\r\n      for (const key in source) {\r\n        if (isObject(source[key])) {\r\n          if (!target[key]) target[key] = {}\r\n          mergeObjects(target[key], source[key])\r\n        } \r\n        else if (isArray(source[key]) && isArray(target[key])) {\r\n          target[key] = target[key].concat(source[key]) \r\n        }\r\n        else {\r\n          Object.assign(target, { [key]: source[key] })\r\n        }\r\n      }\r\n    }\r\n  \r\n    return mergeObjects(target, ...sources);\r\n  }","import * as yup from 'yup';\r\nimport { AnySchema, SchemaDescription } from \"yup/lib/schema\";\r\nimport { isArray, mergeObjects } from \"./utils\";\r\n\r\nconst __yuptoswagger__: any = { debug: false }\r\n\r\nconst { warn: warn_ } = console;\r\nconsole.warn = (...args) => __yuptoswagger__.debug ? warn_(...args) : undefined\r\n\r\ntype YTSCompilerOptions = {\r\n    debug: boolean;\r\n}\r\n\r\nclass YTSCompiler {\r\n    protected debug: boolean = false;\r\n    constructor(options?: YTSCompilerOptions) {\r\n        const keys: string[] = Object.keys(options || {});\r\n        for (let key of keys) {\r\n            switch (key) {\r\n                case \"debug\":\r\n                    __yuptoswagger__.debug = true;\r\n                    break;\r\n                default:\r\n                    console.warn(`${key} is not recognized as a valid option property`)\r\n            }\r\n        }\r\n    }\r\n\r\n    parse_tests(type: string, tests: any[]): any {\r\n        const map: any = {\r\n          \"string\": {\r\n              \"min\": \"minLength\",\r\n              \"max\": \"maxLength\",\r\n              \"email\": \"format\",\r\n              \"url\": \"format\",\r\n              \"uuid\": \"format\",\r\n              \"matches\": [ \"pattern\", \"regex\" ],\r\n              // required: todo\r\n          },\r\n          \"array\": {\r\n            \"min\": \"minItems\",\r\n            \"max\": \"maxItems\"\r\n          }\r\n        }\r\n\r\n        let properties: any = {};\r\n        console.log({ type })\r\n        const type_map = map[type];\r\n        for (let test of tests){\r\n              const { name, params } = test;\r\n            const match = type_map[name]\r\n            if (!match) {\r\n              console.warn(`[WARN] yuptoswagger.js: ignoring ${name}`)\r\n              continue\r\n            }\r\n            if (isArray(match) && match.length == 2) {\r\n              const [ key, value_key ] = match;\r\n              const value = params[value_key]\r\n              const value_str = value.toString ? value.toString() : value\r\n              properties[key] = value_str\r\n              continue\r\n            }\r\n            const value = params[name] || name\r\n            properties[match] = value;\r\n            console.log({ [match]: value })\r\n        }\r\n        return properties\r\n    }\r\n    parse_string_schema(type: string, properties: any) {\r\n        const { oneOf, tests } = properties;\r\n        \r\n        const enum_ = oneOf;\r\n\r\n        const schema: any = { type, enum: enum_ }\r\n\r\n        return schema;\r\n    }\r\n    parse_object_schema(type: string, properties: any) {\r\n      const schema = { type }\r\n      const fields = []\r\n      for (const field_key of Object.keys(properties.fields)) {\r\n        const field: SchemaDescription = properties.fields[field_key];\r\n        const parsed = this.compile(field)\r\n        fields.push(parsed);\r\n      }\r\n      return { ...schema, fields }\r\n    }\r\n    parse_array_schema(type: string, properties: any) {\r\n      const schema = { type }\r\n      const innerType: any = properties.innerType;\r\n      const items = this.compile(innerType)\r\n      return { ...schema, items }\r\n    }\r\n    parse_spec_field(spec: any) {\r\n      const parsed: any = { }\r\n      \r\n      const { nullable } = spec;\r\n\r\n      if (nullable) parsed.nullable = nullable;\r\n      \r\n      return parsed;\r\n    }\r\n    parse_oneOf_field(fields: any[]) {\r\n      const parsed_fields: any[] = [];\r\n      for (let field of fields){\r\n        const parsed = this.compile(field);\r\n        parsed_fields.push(parsed);\r\n      }\r\n      return parsed_fields\r\n    }\r\n    isYupSchema<T extends AnySchema>(object: T): T | false {\r\n      return object.__isYupSchema__ ? object : false;\r\n    }\r\n    compile(schema: AnySchema | SchemaDescription): any;\r\n    compile(schema: AnySchema | SchemaDescription & { spec?: any }) {\r\n      let schema_description = schema;\r\n      \r\n      const yupSchema = this.isYupSchema(schema as AnySchema)\r\n      if (yupSchema) schema_description = yupSchema.describe();\r\n\r\n      console.log(schema_description,'schema_description');\r\n\r\n      const { type, ...properties } = schema_description;\r\n\r\n      let swagger_schema: any = {}\r\n      switch (type) {\r\n          // todo: ref case\r\n          // todo: oneOf case\r\n          // todo: allow users to add manually properties that are not mapped with yup (eg. uniqueItems)\r\n          case \"string\": swagger_schema = this.parse_string_schema(type, properties); break;\r\n          case \"object\": swagger_schema = this.parse_object_schema(type, properties); break;\r\n          case \"array\": swagger_schema = this.parse_array_schema(type, properties); break;\r\n          default: return { failed: true };\r\n      }\r\n      const from_test_properties = this.parse_tests(type, properties.tests);\r\n      const spec_properties = this.parse_spec_field(properties!.spec);\r\n      \r\n      if (schema_description.oneOf) {\r\n        const oneOf = this.parse_oneOf_field(schema_description.oneOf as any[]);\r\n        console.log(\"OKOK\", oneOf)\r\n        mergeObjects(swagger_schema, { oneOf });\r\n      }\r\n\r\n      return mergeObjects({}, swagger_schema, from_test_properties, spec_properties);\r\n    }\r\n}\r\n\r\nexport default YTSCompiler;"],"names":["isObject","item","Array","isArray","mergeObjects","target","sources","length","source","shift","key","concat","Object","assign","__yuptoswagger__","debug","warn","warn_","console","args","undefined","YTSCompiler","constructor","options","keys","parse_tests","type","tests","map","properties","log","type_map","test","name","params","match","value_key","value","value_str","toString","parse_string_schema","oneOf","enum_","schema","enum","parse_object_schema","fields","field_key","field","parsed","compile","push","parse_array_schema","innerType","items","parse_spec_field","spec","nullable","parse_oneOf_field","parsed_fields","isYupSchema","object","__isYupSchema__","schema_description","yupSchema","describe","swagger_schema","failed","from_test_properties","spec_properties"],"mappings":"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"}